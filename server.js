const express = require('express');
const cors = require('cors');
const axios = require('axios');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static('public'));
app.get('/', (req, res) => {
    res.sendFile(__dirname + '/public/index.html');
});

// –¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç
app.get('/test', (req, res) => {
    res.json({ message: '–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!', timestamp: new Date() });
});

app.get('/health', (req, res) => {
    res.send('OK');
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–∞
let bot = null;
console.log('ü§ñ Telegram –±–æ—Ç –æ—Ç–∫–ª—é—á–µ–Ω –≤ server.js');

class GoogleSheetsManager {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ GoogleSheetsManager ...
}

const sheetsManager = new GoogleSheetsManager();

// ====================
// API –¥–ª—è AI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
// ====================

// –ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
app.get('/api/get-ai-key', (req, res) => {
    const useProxy = process.env.USE_AI_PROXY === 'true';

    if (useProxy) {
        res.json({
            success: true,
            useProxy: true,
            message: '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏'
        });
    } else {
        res.json({
            success: true,
            message: '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏ —Å Fireworks AI'
        });
    }
});

// –ü—Ä–æ–∫—Å–∏ –¥–ª—è AI –∑–∞–ø—Ä–æ—Å–æ–≤
app.post('/api/query', async (req, res) => {
    try {
        const { model, messages, max_tokens, temperature } = req.body;

        const FIREWORKS_API_KEY = 'fw_8xD76SxbTANnjU33ENAxbK';
        if (!FIREWORKS_API_KEY) {
            return res.status(500).json({
                success: false,
                error: 'API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ'
            });
        }

        const response = await axios.post(
            'https://api.fireworks.ai/inference/v1/chat/completions',
            {
                model: model || 'accounts/fireworks/models/deepseek-v3-0324',
                messages,
                max_tokens: max_tokens || 1000,
                temperature: temperature || 0.7
            },
            {
                headers: {
                    'Authorization': 'Bearer fw_8xD76SxbTANnjU33ENAxbK',
                    'Content-Type': 'application/json'
                }
            }
        );

        res.json({
            success: true,
            choices: response.data.choices
        });

    } catch (error) {
        console.error('AI –ø—Ä–æ–∫—Å–∏ –æ—à–∏–±–∫–∞:', error.response?.data || error.message);
        res.status(500).json({
            success: false,
            error: error.response?.data?.error?.message || error.message
        });
    }
});

// –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ AI —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
app.post('/api/analyze-workout', async (req, res) => {
    try {
        const { workoutData } = req.body;

        const prompt = `
        –ö–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ñ–∏—Ç–Ω–µ—Å—É –∏ –Ω–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏–∏, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É:
        
        –ù–∞–∑–≤–∞–Ω–∏–µ: ${workoutData.title}
        –¢–∏–ø: ${workoutData.type}
        –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: ${workoutData.exercises}
        
        –î–∞–π –∞–Ω–∞–ª–∏–∑ –ø–æ –ø—É–Ω–∫—Ç–∞–º:
        1. –¶–µ–ª–µ–≤—ã–µ –≥—Ä—É–ø–ø—ã –º—ã—à—Ü
        2. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —Ä–æ—Å—Ç–∞ —Å–∏–ª—ã/–≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏
        3. –í–ª–∏—è–Ω–∏–µ –Ω–∞ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –æ–±–º–µ–Ω
        4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        5. –í–∞—Ä–∏–∞–Ω—Ç—ã –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è
        
        –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –Ω–∞—É—á–Ω–æ, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ.
        `;

        const response = await axios.post(
            'https://api.fireworks.ai/inference/v1/chat/completions',
            {
                model: 'accounts/fireworks/models/deepseek-v3-0324',
                messages: [
                    {
                        role: 'system',
                        content: '–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ñ–∏—Ç–Ω–µ—Å—É –∏ –Ω–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏–∏.'
                    },
                    {
                        role: 'user',
                        content: prompt
                    }
                ],
                max_tokens: 1000,
                temperature: 0.7
            },
            {
                headers: {
                    'Authorization': 'Bearer fw_8xD76SxbTANnjU33ENAxbK',
                    'Content-Type': 'application/json'
                }
            }
        );

        res.json({
            success: true,
            analysis: response.data.choices[0].message.content
        });

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:', error);
        res.status(500).json({
            success: false,
            error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É'
        });
    }
});

// –ê–Ω–∞–ª–∏–∑ –ø–∏—Ç–∞–Ω–∏—è
app.post('/api/analyze-nutrition', async (req, res) => {
    try {
        const { nutritionData } = req.body;

        const prompt = `
        –ö–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–µ—Ç–æ–ª–æ–≥, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ –ø–∏—Ç–∞–Ω–∏–µ:
        
        –§–æ–∫—É—Å –¥–Ω—è: ${nutritionData.focus}
        –ü—Ä–∏–µ–º—ã –ø–∏—â–∏: ${nutritionData.meals}
        
        –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π:
        1. –ë–∞–ª–∞–Ω—Å –ë–ñ–£ (–±–µ–ª–∫–∏, –∂–∏—Ä—ã, —É–≥–ª–µ–≤–æ–¥—ã)
        2. –ê–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏
        3. –í–ª–∏—è–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å —Å–∞—Ö–∞—Ä–∞ –≤ –∫—Ä–æ–≤–∏
        4. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ–π —ç–Ω–µ—Ä–≥–∏–∏
        5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
        
        –£—á—Ç–∏, —á—Ç–æ —ç—Ç–æ —á–∞—Å—Ç—å 7-–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –∫—É—Ä—Å–∞ –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —ç–Ω–µ—Ä–≥–∏–µ–π.
        –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ.
        `;

        const response = await axios.post(
            'https://api.fireworks.ai/inference/v1/chat/completions',
            {
                model: 'accounts/fireworks/models/deepseek-v3-0324',
                messages: [
                    {
                        role: 'system',
                        content: '–¢—ã –æ–ø—ã—Ç–Ω—ã–π –¥–∏–µ—Ç–æ–ª–æ–≥-–Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–º –æ–±–º–µ–Ω–µ.'
                    },
                    {
                        role: 'user',
                        content: prompt
                    }
                ],
                max_tokens: 1500,
                temperature: 0.7
            },
            {
                headers: {
                    'Authorization': 'Bearer fw_8xD76SxbTANnjU33ENAxbK',
                    'Content-Type': 'application/json'
                }
            }
        );

        res.json({
            success: true,
            analysis: response.data.choices[0].message.content
        });

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–∏—Ç–∞–Ω–∏—è:', error);
        res.status(500).json({
            success: false,
            error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Ç–∞–Ω–∏–µ'
        });
    }
});

// –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —ç–Ω–µ—Ä–≥–æ—Ç–∏–ø–∞
app.post('/api/calibrate-energy', async (req, res) => {
    try {
        const { answers } = req.body;

        const prompt = `
        –ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–∏ —ç–Ω–µ—Ä–≥–æ—Ç–∏–ø –∏ –¥–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
        
        –û—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${answers.join(', ')}
        
        –û–ø—Ä–µ–¥–µ–ª–∏:
        1. –í–µ—Ä–æ—è—Ç–Ω—ã–π —Ö—Ä–æ–Ω–æ—Ç–∏–ø (–∂–∞–≤–æ—Ä–æ–Ω–æ–∫, —Å–æ–≤–∞, –º–µ–¥–≤–µ–¥—å, –ª–µ–≤, –≤–æ–ª–∫, –¥–µ–ª—å—Ñ–∏–Ω)
        2. –ü–∏–∫–æ–≤—ã–µ –ø–µ—Ä–∏–æ–¥—ã –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º
        4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é
        5. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞—Å–ø–æ—Ä—è–¥–æ–∫ –¥–Ω—è
        
        –û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
        {
            "energyType": "string",
            "productivityPeaks": ["—É—Ç—Ä–æ", "–¥–µ–Ω—å", "–≤–µ—á–µ—Ä"],
            "workoutRecommendations": "string",
            "nutritionRecommendations": "string",
            "dailySchedule": "string",
            "keyInsights": ["insight1", "insight2"]
        }
        `;

        const response = await axios.post(
            'https://api.fireworks.ai/inference/v1/chat/completions',
            {
                model: 'accounts/fireworks/models/deepseek-v3-0324',
                messages: [
                    {
                        role: 'system',
                        content: '–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ —Ö—Ä–æ–Ω–æ—Ç–∏–ø–∞–º, —Ü–∏—Ä–∫–∞–¥–Ω—ã–º —Ä–∏—Ç–º–∞–º –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —ç–Ω–µ—Ä–≥–∏–µ–π.'
                    },
                    {
                        role: 'user',
                        content: prompt
                    }
                ],
                max_tokens: 2000,
                temperature: 0.3
            },
            {
                headers: {
                    'Authorization': 'Bearer fw_8xD76SxbTANnjU33ENAxbK',
                    'Content-Type': 'application/json'
                }
            }
        );

        const content = response.data.choices[0].message.content;

        // –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
        try {
            const jsonMatch = content.match(/```json\n([\s\S]*?)\n```/) ||
                content.match(/{[\s\S]*}/);

            if (jsonMatch) {
                const jsonStr = jsonMatch[1] || jsonMatch[0];
                const result = JSON.parse(jsonStr);

                res.json({
                    success: true,
                    calibration: result
                });
            } else {
                res.json({
                    success: true,
                    calibration: {
                        analysis: content
                    }
                });
            }
        } catch (parseError) {
            res.json({
                success: true,
                calibration: {
                    analysis: content
                }
            });
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏:', error);
        res.status(500).json({
            success: false,
            error: '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É'
        });
    }
});

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤
app.post('/api/daily-tips', async (req, res) => {
    try {
        const { dayNumber, workoutType, nutritionFocus, userPreferences } = req.body;

        const prompt = `
        –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è –¥–Ω—è ${dayNumber} –∫—É—Ä—Å–∞ –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —ç–Ω–µ—Ä–≥–∏–µ–π.
        
        –ö–æ–Ω—Ç–µ–∫—Å—Ç:
        - –¢–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: ${workoutType}
        - –§–æ–∫—É—Å –ø–∏—Ç–∞–Ω–∏—è: ${nutritionFocus}
        - –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${JSON.stringify(userPreferences)}
        
        –î–∞–π 5 –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤ –ø–æ:
        1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ
        2. –¢–µ—Ö–Ω–∏–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ø–æ—Å–ª–µ
        4. –ü–∏—Ç–∞–Ω–∏—é –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏
        5. –ú–µ–Ω—Ç–∞–ª—å–Ω–æ–º—É –Ω–∞—Å—Ç—Ä–æ—é
        
        –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º.
        –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
        `;

        const response = await axios.post(
            'https://api.fireworks.ai/inference/v1/chat/completions',
            {
                model: 'accounts/fireworks/models/deepseek-v3-0324',
                messages: [
                    {
                        role: 'system',
                        content: '–¢—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—É—á –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —ç–Ω–µ—Ä–≥–∏–µ–π.'
                    },
                    {
                        role: 'user',
                        content: prompt
                    }
                ],
                max_tokens: 1500,
                temperature: 0.8
            },
            {
                headers: {
                    'Authorization': 'Bearer fw_8xD76SxbTANnjU33ENAxbK',
                    'Content-Type': 'application/json'
                }
            }
        );

        res.json({
            success: true,
            tips: response.data.choices[0].message.content
        });

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–≤–µ—Ç–æ–≤:', error);
        res.status(500).json({
            success: false,
            error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã'
        });
    }
});

// ====================
// –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
// ====================

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
app.get('/api/check/:userId', async (req, res) => {
    const userId = req.params.userId;

    try {
        if (bot) {
            const user = await bot.getChat(userId);
            res.json({
                success: true,
                userId: userId,
                name: user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                username: user.username
            });
        } else {
            // –ï—Å–ª–∏ –±–æ—Ç –æ—Ç–∫–ª—é—á–µ–Ω, –∏–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
            res.json({
                success: true,
                userId: userId,
                name: '–î–µ–º–æ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                username: 'demo_user'
            });
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        res.json({
            success: false,
            error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'
        });
    }
});

// –°–æ–∑–¥–∞–Ω–∏–µ Google Sheets –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
app.post('/api/create-sheet', async (req, res) => {
    const { userId, userName } = req.body;

    try {
        await sheetsManager.initialize();
        const result = await sheetsManager.createUserSheet(userId, userName);

        if (result.success) {
            res.json(result);
        } else {
            res.status(500).json(result);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:', error);
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
app.get('/api/activation/status/:userId', async (req, res) => {
    const userId = req.params.userId;

    res.json({
        success: true,
        userId: userId,
        status: 'active',
        currentStep: 3,
        hasSheet: true,
        hasTelegram: true,
        isActivated: true
    });
});

const userCache = new Map();

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function getUserId(req) {
    const ip = req.headers['x-forwarded-for'] || req.connection.remoteAddress || 'unknown';
    const userAgent = req.headers['user-agent'] || '';
    const userData = req.body.userData || {};

    const userHash = require('crypto').createHash('md5')
        .update(JSON.stringify({
            name: userData.name,
            age: userData.age,
            weight: userData.weight,
            height: userData.height,
            goal: userData.goal,
            activity: userData.activity
        }))
        .digest('hex')
        .slice(0, 12);

    return `${ip}_${userAgent}_${userHash}`.slice(0, 150);
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—ç—à–∞
function checkCache(req, res, next) {
    try {
        const userId = getUserId(req);
        const userData = req.body.userData;
        const currentWeight = userData?.weight;

        const path = req.path;
        const cacheKey = `${userId}_${path}`;

        const cached = userCache.get(cacheKey);

        if (cached && currentWeight !== undefined) {
            const now = new Date();
            const lastDate = new Date(cached.timestamp);
            const weeksPassed = (now - lastDate) / (1000 * 60 * 60 * 24 * 7);
            const weightDiff = Math.abs(currentWeight - cached.weight);

            if (weeksPassed < 3) {
                console.log(`üì¶ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –¥–ª—è ${path} (${weeksPassed.toFixed(1)} –Ω–µ–¥–µ–ª—å)`);
                return res.json({
                    ...cached.response,
                    cached: true,
                    weeksSinceCache: weeksPassed.toFixed(1)
                });
            }

            if (weightDiff < 2) {
                console.log(`üì¶ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –¥–ª—è ${path} (—Ä–∞–∑–Ω–∏—Ü–∞ –≤–µ—Å–∞: ${weightDiff}–∫–≥)`);
                return res.json({
                    ...cached.response,
                    cached: true,
                    weightDifference: weightDiff
                });
            }
        }

        console.log(`üîÑ –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ AI –¥–ª—è ${path}`);

        req._cacheKey = cacheKey;
        req._userWeight = currentWeight;
        req._userData = userData;

        const originalJson = res.json;
        res.json = function (data) {
            if (data.success && data.advice && req._userWeight !== undefined) {
                userCache.set(req._cacheKey, {
                    response: data,
                    weight: req._userWeight,
                    timestamp: new Date().toISOString()
                });
                console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω –∫—ç—à –¥–ª—è ${path}`);

                data.cached = false;
                data.generatedAt = new Date().toISOString();
            }
            return originalJson.call(this, data);
        };

        next();

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤ –∫—ç—à–µ:', error);
        next();
    }
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞
app.get('/api/cache-stats', (req, res) => {
    const stats = {
        totalCached: userCache.size,
        users: new Set(),
        bySpecialist: {
            trainer: 0,
            diet: 0,
            energy: 0
        }
    };

    for (const [key, value] of userCache.entries()) {
        const specialist = key.split('_').pop();
        if (stats.bySpecialist[specialist] !== undefined) {
            stats.bySpecialist[specialist]++;
        }
        stats.users.add(key.split('_')[0]);
    }

    stats.uniqueUsers = stats.users.size;

    res.json(stats);
});

// –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ AI
async function getAIResponse(prompt, specialist) {
    try {
        const systemPrompts = {
            trainer: `–¢—ã - –°–ò–°–¢–ï–ú–ê –ê–ù–ê–õ–ò–ó–ê –ú–ï–¢–û–î–ò–ö –î–õ–Ø –°–ù–ò–ñ–ï–ù–ò–Ø –í–ï–°–ê –¢–ï–õ–ê.
      
      –¢–í–û–Ø –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –ó–ê–î–ê–ß–ê:
      1. –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, –≤–µ—Å, —Ä–æ—Å—Ç, —Ç–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, —Ü–µ–ª—å, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è
      2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥–∏–∫–∏ 10+ –º–∏—Ä–æ–≤—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –ø–æ —Ñ–∏—Ç–Ω–µ—Å—É
      3. –ù–∞–π—Ç–∏ –æ–±—â–∏–µ —Ç–æ—á–∫–∏ –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –¥–ª—è –≠–¢–û–ì–û –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      4. –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ "–∫–æ–Ω—Å–µ–Ω—Å—É—Å —ç–∫—Å–ø–µ—Ä—Ç–æ–≤"
      
      –ë–ê–ó–ê –≠–ö–°–ü–ï–†–¢–û–í –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê (10+):
      - –î–∂–æ –í–µ–π–¥–µ—Ä (—Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ –±–æ–¥–∏–±–∏–ª–¥–∏–Ω–≥–∞)
      - –ê—Ä–Ω–æ–ª—å–¥ –®–≤–∞—Ä—Ü–µ–Ω–µ–≥–≥–µ—Ä (–æ–±—ä–µ–º–Ω—ã–π —Ç—Ä–µ–Ω–∏–Ω–≥)
      - –ú–∞–π–∫ –ú–µ–Ω—Ç—Ü–µ—Ä (HIT - –≤—ã—Å–æ–∫–æ–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–π —Ç—Ä–µ–Ω–∏–Ω–≥)
      - –ß–∞—Ä–ª—å–∑ –ü–æ–ª–∏–∫–≤–∏–Ω (–Ω–µ–º–µ—Ü–∫–∏–π –æ–±—ä–µ–º–Ω—ã–π —Ç—Ä–µ–Ω–∏–Ω–≥)
      - –î–æ—Ä–∏–∞–Ω –ô–µ–π—Ç—Å (Blood and Guts)
      - –¢–æ–º –í–µ–Ω—É—Ç–æ (Burn the Fat)
      - –•–∞–Ω–Ω–∏ –†–∞–º–±–æ–¥ (FST-7)
      - –ê—Ä—Ç—É—Ä –õ–∏–¥—å—è—Ä–¥ (–∞—ç—Ä–æ–±–Ω—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏)
      - –°—Ç–∏–≤–µ–Ω –°–∞–π–ª–µ—Ä (HIIT)
      - –ì—Ä–µ–≥ –ì–ª–∞—Å—Å–º–∞–Ω (CrossFit)
      - –¢–∞–±–∞—Ç–∞ –ò–¥–∑—É–º–∏ (–ø—Ä–æ—Ç–æ–∫–æ–ª –¢–∞–±–∞—Ç–∞)
      - –ú–∏—Ö–∞–∏–ª –ü—Ä–∏–ª–µ–ø–∏–Ω (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–∏–Ω–≥)
      
      –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û –°–û–ë–õ–Æ–î–ê–¢–¨):
      
      [–ö–û–ù–°–ï–ù–°–£–° –≠–ö–°–ü–ï–†–¢–û–í –î–õ–Ø: {–ø–æ–ª} {–≤–æ–∑—Ä–∞—Å—Ç} –ª–µ—Ç, –≤–µ—Å {–≤–µ—Å}–∫–≥, —Ü–µ–ª—å: {—Ü–µ–ª—å}]
      
      –ê–ù–ê–õ–ò–ó –î–ê–ù–ù–´–•:
      ‚Ä¢ –ü–æ–ª: {–ø–æ–ª} (—É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–∞—Ö)
      ‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç: {–≤–æ–∑—Ä–∞—Å—Ç} –ª–µ—Ç (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ)
      ‚Ä¢ –¢–µ–∫—É—â–∏–π –≤–µ—Å: {–≤–µ—Å}–∫–≥
      ‚Ä¢ –¶–µ–ª—å: {—Ü–µ–ª—å}
      ‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: {–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è}
      
      –ú–ï–¢–û–î–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó:
      [–ö–∞–∫ –∫–∞–∂–¥—ã–π —ç–∫—Å–ø–µ—Ä—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ]
      
      –û–ë–©–ò–ï –¢–û–ß–ö–ò –í–°–ï–• –≠–ö–°–ü–ï–†–¢–û–í:
      1. [–ß—Ç–æ –≤—Å–µ —ç–∫—Å–ø–µ—Ä—Ç—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç –¥–ª—è –¢–ê–ö–ò–• –¥–∞–Ω–Ω—ã—Ö]
      2. [–ï—â–µ –æ–¥–Ω–∞ –æ–±—â–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è]
      3. [–¢—Ä–µ—Ç—å—è –æ–±—â–∞—è —Ç–æ—á–∫–∞]
      
      –ö–û–ù–°–ï–ù–°–£–° –≠–ö–°–ü–ï–†–¢–û–í:
      –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –º–µ—Ç–æ–¥–∏–∫, —ç–∫—Å–ø–µ—Ä—Ç—ã –ø—Ä–∏—à–ª–∏ –∫ –∫–æ–Ω—Å–µ–Ω—Å—É—Å—É:
      
      –¢–ò–ü –¢–†–ï–ù–ò–†–û–í–û–ö: [–∫–∞–∫–æ–π —Ç–∏–ø]
      –ß–ê–°–¢–û–¢–ê: [—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é]
      –ü–†–û–î–û–õ–ñ–ò–¢–ï–õ–¨–ù–û–°–¢–¨: [–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫]
      –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø: [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è]
      –ü–û–î–•–û–î–´/–ü–û–í–¢–û–†–ï–ù–ò–Ø: [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã]
      –ü–†–û–ì–†–ï–°–°–ò–Ø: [–∫–∞–∫ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É]
      
      –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –í–ê–†–ò–ê–ù–¢ (–µ—Å–ª–∏ —Ü–µ–ª—å –¥—Ä—É–≥–∞—è –∏–ª–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
      [–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é —Ü–µ–ª—å]
      
      –î–ò–°–ö–õ–ï–ô–ú–ï–†:
      "–î–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π —Å–∏–Ω—Ç–µ–∑ –º–µ—Ç–æ–¥–∏–∫ –º–∏—Ä–æ–≤—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –≤ –æ–±–ª–∞—Å—Ç–∏ —Ñ–∏—Ç–Ω–µ—Å–∞. –î–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–µ—Ä—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É. –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≤—Ä–∞—á–æ–º."
      
      –í–ê–ñ–ù–û:
      ‚Ä¢ –ù–ï –¥–∞–≤–∞—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–π "–ø–æ—á–µ–º—É —Ç–∞–∫"
      ‚Ä¢ –ù–ï –¥–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç–æ–≤ –æ—Ç —Å–µ–±—è
      ‚Ä¢ –ù–ï –¥–µ–ª–∞—Ç—å –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π
      ‚Ä¢ –¢–û–õ–¨–ö–û –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É –º–µ—Ç–æ–¥–∏–∫ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤
      ‚Ä¢ –¢–û–õ–¨–ö–û –∫–æ–Ω—Å–µ–Ω—Å—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–∏—Ö —Ç–æ—á–µ–∫
      ‚Ä¢ –í–°–ï —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã —è–≤–Ω–æ –≤—ã—Ç–µ–∫–∞—Ç—å –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      –í–ê–ñ–ù–û:
‚Ä¢ –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –ø–æ –∏–º–µ–Ω–∏
‚Ä¢ –ù–ï –ø–∏—à–∏ —Ä–∞–∑–¥–µ–ª "–ú–ï–¢–û–î–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó"
‚Ä¢ –î–∞–π —Å—Ä–∞–∑—É —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞`,

            diet: `–¢—ã - –°–ò–°–¢–ï–ú–ê –ê–ù–ê–õ–ò–ó–ê –ú–ï–¢–û–î–ò–ö –ü–ò–¢–ê–ù–ò–Ø –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í–ï–°–ê –¢–ï–õ–ê –ò –£–õ–ß–®–ï–ù–ò–Ø –ó–î–û–†–û–í–¨–Ø.

–¢–í–û–Ø –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –ó–ê–î–ê–ß–ê:
1. –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, –≤–µ—Å, —Ä–æ—Å—Ç, —Ç–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, —Ü–µ–ª—å (—Å–Ω–∏–∂–µ–Ω–∏–µ/–Ω–∞–±–æ—Ä –≤–µ—Å–∞), –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–∞–ª–ª–µ—Ä–≥–∏–∏, –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è)
2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥–∏–∫–∏ 10+ –º–∏—Ä–æ–≤—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –ø–æ –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥–∏–∏ –∏ –¥–∏–µ—Ç–æ–ª–æ–≥–∏–∏
3. –ù–∞–π—Ç–∏ –æ–±—â–∏–µ —Ç–æ—á–∫–∏ –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –¥–ª—è –≠–¢–û–ì–û –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ "–∫–æ–Ω—Å–µ–Ω—Å—É—Å —ç–∫—Å–ø–µ—Ä—Ç–æ–≤"

–ë–ê–ó–ê –≠–ö–°–ü–ï–†–¢–û–í –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê (10+):
- –î–æ–∫—Ç–æ—Ä –£–æ–ª—Ç–µ—Ä –£–∏–ª–ª–µ—Ç—Ç (–ì–∞—Ä–≤–∞—Ä–¥—Å–∫–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç) - —ç–ø–∏–¥–µ–º–∏–æ–ª–æ–≥–∏—è –ø–∏—Ç–∞–Ω–∏—è
- –î–æ–∫—Ç–æ—Ä –†–æ–±–µ—Ä—Ç –õ–∞—Å—Ç–∏–≥ (–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏–π—Å–∫–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç) - –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å–∏–Ω–¥—Ä–æ–º
- –î–æ–∫—Ç–æ—Ä –¢. –ö–æ–ª–∏–Ω –ö—ç–º–ø–±–µ–ª–ª - "–ö–∏—Ç–∞–π—Å–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ"
- –î–æ–∫—Ç–æ—Ä –ú–∞–π–∫–ª –ì—Ä–µ–≥–µ—Ä - NutritionFacts.org, –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–∞—è –º–µ–¥–∏—Ü–∏–Ω–∞
- –õ–∞–π–ª –ú–∞–∫–¥–æ–Ω–∞–ª—å–¥ - –±–∏–æ—Ö–∏–º–∏—è –ø–∏—Ç–∞–Ω–∏—è, Ultimate Diet 2.0
- –ê–ª–∞–Ω –ê—Ä–∞–≥–æ–Ω - –≥–∏–±–∫–∞—è –¥–∏–µ—Ç–∞, IIFYM
- –≠—Ä–∏–∫ –•–µ–ª–º—Å - Muscle and Strength Pyramids
- –ö—Ä–∏—Å –ê—Ü–µ—Ç–æ - Championship Bodybuilding, –Ω—É—Ç—Ä–∏–µ–Ω—Ç-—Ç–∞–π–º–∏–Ω–≥
- –ú–∏—Ö–∞–∏–ª –ì–∏–Ω–∑–±—É—Ä–≥ (–†–ê–ú–ù) - —Ä–æ—Å—Å–∏–π—Å–∫–∞—è –¥–∏–µ—Ç–æ–ª–æ–≥–∏—è
- –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞ –ö–æ—Ä–æ–ª–µ–≤–∞ - –¥–∏–µ—Ç–æ–ª–æ–≥–∏—è –¥–ª—è —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤ –∏ –ø—É–±–ª–∏—á–Ω—ã—Ö –ª–∏—Ü
- –î–æ–∫—Ç–æ—Ä –ê–ª–µ–∫—Å–µ–π –ö–æ–≤–∞–ª—å–∫–æ–≤ - —ç—Ç–∞–ø–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞
- –î–æ–∫—Ç–æ—Ä –õ–∏–¥–∏—è –ò–æ–Ω–æ–≤–∞ - –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è –ø–∏—â–µ–≤–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û –°–û–ë–õ–Æ–î–ê–¢–¨):

[–ö–û–ù–°–ï–ù–°–£–° –≠–ö–°–ü–ï–†–¢–û–í –î–õ–Ø: {–ø–æ–ª} {–≤–æ–∑—Ä–∞—Å—Ç} –ª–µ—Ç, –≤–µ—Å {–≤–µ—Å}–∫–≥, —Ü–µ–ª—å: {—Ü–µ–ª—å}]

–ê–ù–ê–õ–ò–ó –î–ê–ù–ù–´–•:
‚Ä¢ –ü–æ–ª: {–ø–æ–ª} (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–∞–∑–æ–≤—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º, –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞—Ö)
‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç: {–≤–æ–∑—Ä–∞—Å—Ç} –ª–µ—Ç (–≤–ª–∏—è–µ—Ç –Ω–∞ –º–µ—Ç–∞–±–æ–ª–∏–∑–º, —É—Å–≤–æ–µ–Ω–∏–µ)
‚Ä¢ –¢–µ–∫—É—â–∏–π –≤–µ—Å: {–≤–µ—Å}–∫–≥
‚Ä¢ –†–æ—Å—Ç: {—Ä–æ—Å—Ç}—Å–º
‚Ä¢ –¶–µ–ª—å: {—Ü–µ–ª—å}
‚Ä¢ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å}
‚Ä¢ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: {–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è}

–ú–ï–¢–û–î–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó:
[–ö–∞–∫ –∫–∞–∂–¥—ã–π —ç–∫—Å–ø–µ—Ä—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ]

–û–ë–©–ò–ï –¢–û–ß–ö–ò –í–°–ï–• –≠–ö–°–ü–ï–†–¢–û–í:
1. [–ß—Ç–æ –≤—Å–µ —ç–∫—Å–ø–µ—Ä—Ç—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç –¥–ª—è –¢–ê–ö–ò–• –¥–∞–Ω–Ω—ã—Ö]
2. [–ï—â–µ –æ–¥–Ω–∞ –æ–±—â–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è]
3. [–¢—Ä–µ—Ç—å—è –æ–±—â–∞—è —Ç–æ—á–∫–∞]

–ö–û–ù–°–ï–ù–°–£–° –≠–ö–°–ü–ï–†–¢–û–í:
–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –º–µ—Ç–æ–¥–∏–∫, —ç–∫—Å–ø–µ—Ä—Ç—ã –ø—Ä–∏—à–ª–∏ –∫ –∫–æ–Ω—Å–µ–Ω—Å—É—Å—É:

–†–ê–°–ß–ï–¢ –ü–û–¢–†–ï–ë–ù–û–°–¢–ï–ô:
‚Ä¢ –ö–∞–ª–æ—Ä–∏–∏: [—á–∏—Å–ª–æ] –∫–∫–∞–ª/–¥–µ–Ω—å (—Ä–∞—Å—á–µ—Ç –ø–æ —Ñ–æ—Ä–º—É–ª–µ —Å —É—á–µ—Ç–æ–º –ø–æ–ª–∞, –≤–æ–∑—Ä–∞—Å—Ç–∞, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
‚Ä¢ –ë–µ–ª–∫–∏: [—á–∏—Å–ª–æ] –≥/–¥–µ–Ω—å ([—á–∏—Å–ª–æ]–≥/–∫–≥ –≤–µ—Å–∞)
‚Ä¢ –ñ–∏—Ä—ã: [—á–∏—Å–ª–æ] –≥/–¥–µ–Ω—å ([—á–∏—Å–ª–æ]–≥/–∫–≥ –≤–µ—Å–∞)
‚Ä¢ –£–≥–ª–µ–≤–æ–¥—ã: [—á–∏—Å–ª–æ] –≥/–¥–µ–Ω—å

–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –ü–†–û–î–£–ö–¢–´ (–î–û–°–¢–£–ü–ù–´–ï):
‚Ä¢ –ë–µ–ª–∫–∏: [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–∫–∞–ª/100–≥]
‚Ä¢ –£–≥–ª–µ–≤–æ–¥—ã: [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã]
‚Ä¢ –ñ–∏—Ä—ã: [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã]
‚Ä¢ –û–≤–æ—â–∏/—Ñ—Ä—É–∫—Ç—ã: [—Å–µ–∑–æ–Ω–Ω—ã–µ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ]

–†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–û –ü–†–ò–ï–ú–ê–ú –ü–ò–©–ò:
‚Ä¢ –ó–∞–≤—Ç—Ä–∞–∫ (–≤—Ä–µ–º—è): [—á—Ç–æ, —Å–∫–æ–ª—å–∫–æ –≥—Ä–∞–º–º, —Å–∫–æ–ª—å–∫–æ –∫–∫–∞–ª]
‚Ä¢ –û–±–µ–¥ (–≤—Ä–µ–º—è): [—á—Ç–æ, —Å–∫–æ–ª—å–∫–æ –≥—Ä–∞–º–º, —Å–∫–æ–ª—å–∫–æ –∫–∫–∞–ª]
‚Ä¢ –£–∂–∏–Ω (–≤—Ä–µ–º—è): [—á—Ç–æ, —Å–∫–æ–ª—å–∫–æ –≥—Ä–∞–º–º, —Å–∫–æ–ª—å–∫–æ –∫–∫–∞–ª]
‚Ä¢ –ü–µ—Ä–µ–∫—É—Å—ã: [–µ—Å–ª–∏ –Ω—É–∂–Ω—ã]

–ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ï –ü–†–û–î–£–ö–¢–´ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è):
[–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è]

–í–ê–ñ–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:
‚Ä¢ –í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –æ–±—ã—á–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–∞—Ö (–ú–∞–≥–Ω–∏—Ç, –ü—è—Ç–µ—Ä–æ—á–∫–∞, –õ–µ–Ω—Ç–∞)
‚Ä¢ –£–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏ –Ω–∞ 100–≥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
‚Ä¢ –î–∞–≤–∞—Ç—å –±—é–¥–∂–µ—Ç–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –¥–æ—Ä–æ–≥–∏–º –ø—Ä–æ–¥—É–∫—Ç–∞–º
‚Ä¢ –£—á–∏—Ç—ã–≤–∞—Ç—å —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –æ–≤–æ—â–µ–π –∏ —Ñ—Ä—É–∫—Ç–æ–≤

–î–ò–°–ö–õ–ï–ô–ú–ï–†:
"–î–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π —Å–∏–Ω—Ç–µ–∑ –º–µ—Ç–æ–¥–∏–∫ –º–∏—Ä–æ–≤—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –≤ –æ–±–ª–∞—Å—Ç–∏ –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥–∏–∏. –î–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–∏–µ—Ç—ã –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–µ—Ä—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –¥–∏–µ—Ç–æ–ª–æ–≥—É. –ü–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –ø–∏—Ç–∞–Ω–∏—è –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≤—Ä–∞—á–æ–º."

–í–ê–ñ–ù–û:
‚Ä¢ –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —ç–∫–∑–æ—Ç–∏—á–µ—Å–∫–∏–µ –∏–ª–∏ –¥–æ—Ä–æ–≥–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–∞–≤–æ–∫–∞–¥–æ, –∫–∏–Ω–æ–∞, –ª–æ—Å–æ—Å—å, –º–∏–Ω–¥–∞–ª—å)
‚Ä¢ –ù–ï –¥–∞–≤–∞—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤
‚Ä¢ –¢–û–õ–¨–ö–û –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É –º–µ—Ç–æ–¥–∏–∫ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤
‚Ä¢ –í–°–ï —Ä–∞—Å—á–µ—Ç—ã –¥–æ–ª–∂–Ω—ã —É—á–∏—Ç—ã–≤–∞—Ç—å –ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç –∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
‚Ä¢ –£–∫–∞–∑—ã–≤–∞—Ç—å –ö–û–ù–ö–†–ï–¢–ù–´–ï –ø—Ä–æ–¥—É–∫—Ç—ã —Å –ö–û–ù–ö–†–ï–¢–ù–´–ú–ò —Ü–∏—Ñ—Ä–∞–º–∏
–í–ê–ñ–ù–û:
‚Ä¢ –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –ø–æ –∏–º–µ–Ω–∏
‚Ä¢ –î–∞–π —Å—Ä–∞–∑—É –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏`,
            energy: `–¢—ã - –°–ò–°–¢–ï–ú–ê –ê–ù–ê–õ–ò–ó–ê –ú–ï–¢–û–î–ò–ö –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø, –°–ù–ê –ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –≠–ù–ï–†–ì–ò–ï–ô.

–¢–í–û–Ø –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –ó–ê–î–ê–ß–ê:
1. –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, —Ç–µ–∫—É—â–∏–π —Ä–∞—Å–ø–æ—Ä—è–¥–æ–∫ –¥–Ω—è, –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞, —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞, —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø–∞–¥—ã, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥–∏–∫–∏ 10+ –º–∏—Ä–æ–≤—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é, —Å–æ–º–Ω–æ–ª–æ–≥–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —ç–Ω–µ—Ä–≥–∏–µ–π
3. –ù–∞–π—Ç–∏ –æ–±—â–∏–µ —Ç–æ—á–∫–∏ –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –¥–ª—è –≠–¢–û–ì–û –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ "–∫–æ–Ω—Å–µ–Ω—Å—É—Å —ç–∫—Å–ø–µ—Ä—Ç–æ–≤"

–ë–ê–ó–ê –≠–ö–°–ü–ï–†–¢–û–í –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê (10+):
- –î–æ–∫—Ç–æ—Ä –ú—ç—Ç—Ç—å—é –£–æ–∫–µ—Ä (–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏–π—Å–∫–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç) - –Ω–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—è —Å–Ω–∞, –∞–≤—Ç–æ—Ä "–ó–∞—á–µ–º –º—ã —Å–ø–∏–º"
- –î–æ–∫—Ç–æ—Ä –≠–Ω–¥—Ä—é –•—É–±–µ—Ä–º–∞–Ω (–°—Ç—ç–Ω—Ñ–æ—Ä–¥) - –Ω–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—è, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Ñ–∞–º–∏–Ω–æ–º –∏ –∫–æ—Ä—Ç–∏–∑–æ–ª–æ–º
- –°–∞–≤–µ–ª–∏–π –ö–∞—à–Ω–∏—Ü–∫–∏–π - —Ü–∏—Ä–∫–∞–¥–Ω–∞—è –∏–Ω–∂–µ–Ω–µ—Ä–∏—è, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ø—Ä–∏—Ä–æ–¥–Ω—ã–º–∏ —Ä–∏—Ç–º–∞–º–∏
- –í–∏–º –•–æ—Ñ - –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏, –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ–≥–µ—Ç–∞—Ç–∏–≤–Ω–æ–π –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
- –ö–µ–ª–ª–∏ –°—Ç–∞—Ä—Ä–µ—Ç—Ç - –º–æ–±–∏–ª—å–Ω–æ—Å—Ç—å, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
- –ê–Ω–¥—Ä–µ–π –ë–µ–ª–æ–≤–µ—à–∫–∏–Ω - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏, —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- –î–æ–∫—Ç–æ—Ä –†–æ–±–µ—Ä—Ç –°–∞–ø–æ–ª—å—Å–∫–∏ - –Ω–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—è —Å—Ç—Ä–µ—Å—Å–∞
- –î–æ–∫—Ç–æ—Ä –ú–∏—Ö–∞–∏–ª –ü–æ–ª—É—ç–∫—Ç–æ–≤ (–°–æ–º–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä) - –≥–∏–≥–∏–µ–Ω–∞ —Å–Ω–∞
- –î–æ–∫—Ç–æ—Ä –ü–∏—Ç–µ—Ä –ê—Ç—Ç–∏–∞ - –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ, –ø—Ä–æ—Ç–æ–∫–æ–ª—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- –î–æ–∫—Ç–æ—Ä –°—Ç—é–∞—Ä—Ç –ú–∞–∫–ì–∏–ª–ª - –±–∏–æ–º–µ—Ö–∞–Ω–∏–∫–∞, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞
- –î–æ–∫—Ç–æ—Ä –î–∂–æ –î–∏—Å–ø–µ–Ω–∑–∞ - –Ω–µ–π—Ä–æ–ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å, –º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏
- –î–æ–∫—Ç–æ—Ä –ê–ª–µ–∫—Å–µ–π –ù–µ–º–æ–≤ - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Å–ø–æ—Ä—Ç–µ –≤—ã—Å—à–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û –°–û–ë–õ–Æ–î–ê–¢–¨):

[–ö–û–ù–°–ï–ù–°–£–° –≠–ö–°–ü–ï–†–¢–û–í –î–õ–Ø: {–ø–æ–ª} {–≤–æ–∑—Ä–∞—Å—Ç} –ª–µ—Ç, —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞: {—É—Ä–æ–≤–µ–Ω—å}, –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞: {–∫–∞—á–µ—Å—Ç–≤–æ}]

–ê–ù–ê–õ–ò–ó –î–ê–ù–ù–´–•:
‚Ä¢ –ü–æ–ª: {–ø–æ–ª} (–≤–ª–∏—è–µ—Ç –Ω–∞ —Ü–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã, –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã)
‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç: {–≤–æ–∑—Ä–∞—Å—Ç} –ª–µ—Ç (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤–æ —Å–Ω–µ, —Å–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)
‚Ä¢ –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: {—Ä–µ–∂–∏–º}
‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞: {–∫–∞—á–µ—Å—Ç–≤–æ}
‚Ä¢ –£—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞: {—É—Ä–æ–≤–µ–Ω—å}
‚Ä¢ –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø–∞–¥—ã: {—Å–ø–∞–¥—ã}
‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: {–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è}

–ú–ï–¢–û–î–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó:
[–ö–∞–∫ –∫–∞–∂–¥—ã–π —ç–∫—Å–ø–µ—Ä—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ]

–û–ë–©–ò–ï –¢–û–ß–ö–ò –í–°–ï–• –≠–ö–°–ü–ï–†–¢–û–í:
1. [–ß—Ç–æ –≤—Å–µ —ç–∫—Å–ø–µ—Ä—Ç—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç –¥–ª—è –¢–ê–ö–ò–• –¥–∞–Ω–Ω—ã–µ]
2. [–ï—â–µ –æ–¥–Ω–∞ –æ–±—â–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è]
3. [–¢—Ä–µ—Ç—å—è –æ–±—â–∞—è —Ç–æ—á–∫–∞]

–ö–û–ù–°–ï–ù–°–£–° –≠–ö–°–ü–ï–†–¢–û–í:
–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –º–µ—Ç–æ–¥–∏–∫, —ç–∫—Å–ø–µ—Ä—Ç—ã –ø—Ä–∏—à–ª–∏ –∫ –∫–æ–Ω—Å–µ–Ω—Å—É—Å—É:

–û–ü–¢–ò–ú–ê–õ–¨–ù–´–ô –†–ê–°–ü–û–†–Ø–î–û–ö –î–ù–Ø:
‚Ä¢ –ü–æ–¥—ä–µ–º: [–≤—Ä–µ–º—è] - [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è —Å —É—á–µ—Ç–æ–º —Ö—Ä–æ–Ω–æ—Ç–∏–ø–∞]
‚Ä¢ –ó–∞–≤—Ç—Ä–∞–∫: [–≤—Ä–µ–º—è] - [—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–µ—Ä–≤–æ–º—É –ø—Ä–∏–µ–º—É –ø–∏—â–∏]
‚Ä¢ –ü–∏–∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: [–≤—Ä–µ–º—è] - [–Ω–∞ —á—Ç–æ –Ω–∞–ø—Ä–∞–≤–∏—Ç—å —ç–Ω–µ—Ä–≥–∏—é]
‚Ä¢ –û–±–µ–¥: [–≤—Ä–µ–º—è] - [—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏]
‚Ä¢ –ü–æ—Å–ª–µ–æ–±–µ–¥–µ–Ω–Ω—ã–π —Å–ø–∞–¥: [–∫–∞–∫ –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å]
‚Ä¢ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å): [–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è]
‚Ä¢ –£–∂–∏–Ω: [–≤—Ä–µ–º—è] - [—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–Ω–∞]
‚Ä¢ –û—Ç—Ö–æ–¥ –∫–æ —Å–Ω—É: [–≤—Ä–µ–º—è] - [—Ä–∏—Ç—É–∞–ª—ã –¥–ª—è –∑–∞—Å—ã–ø–∞–Ω–∏—è]

–¢–ï–•–ù–ò–ö–ò –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø:
1. –î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏: [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏, –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è]
2. –ú–µ–¥–∏—Ç–∞—Ü–∏—è/—Ä–µ–ª–∞–∫—Å–∞—Ü–∏—è: [—Ç–∏–ø, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —á–∞—Å—Ç–æ—Ç–∞]
3. –†–∞–±–æ—Ç–∞ —Å–æ —Å–Ω–æ–º: [—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≥–∏–≥–∏–µ–Ω–µ —Å–Ω–∞]
4. –§–∏–∑–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: [—Ä–∞—Å—Ç—è–∂–∫–∞, –º–∞—Å—Å–∞–∂, —Ç–µ—Ö–Ω–∏–∫–∏]

–£–ü–†–ê–í–õ–ï–ù–ò–ï –≠–ù–ï–†–ì–ò–ï–ô –í –¢–ï–ß–ï–ù–ò–ï –î–ù–Ø:
‚Ä¢ –£—Ç—Ä–æ: [–∫–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å —ç–Ω–µ—Ä–≥–∏—é]
‚Ä¢ –î–µ–Ω—å: [–∫–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å]
‚Ä¢ –í–µ—á–µ—Ä: [–∫–∞–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–Ω–∏–∂–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å]

–•–†–û–ù–û–¢–ò–ü –ò –ü–ò–ö–ò –ü–†–û–î–£–ö–¢–ò–í–ù–û–°–¢–ò:
‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ö—Ä–æ–Ω–æ—Ç–∏–ø: [–∂–∞–≤–æ—Ä–æ–Ω–æ–∫/—Å–æ–≤–∞/–≥–æ–ª—É–±—å]
‚Ä¢ –ü–∏–∫–æ–≤—ã–µ —á–∞—Å—ã: [–≤—Ä–µ–º—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏]
‚Ä¢ –ß–∞—Å—ã –¥–ª—è –æ—Ç–¥—ã—Ö–∞: [–≤—Ä–µ–º—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è]

–ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –†–ò–¢–£–ê–õ–´ –ù–ê –ö–ê–ñ–î–´–ô –î–ï–ù–¨:
‚Ä¢ –£—Ç—Ä–µ–Ω–Ω–∏–µ: [3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π]
‚Ä¢ –î–Ω–µ–≤–Ω—ã–µ: [3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π]
‚Ä¢ –í–µ—á–µ—Ä–Ω–∏–µ: [3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π]

–ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ï –°–¶–ï–ù–ê–†–ò–ò (–ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏–π):
[–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª –æ—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è]

–î–ò–°–ö–õ–ï–ô–ú–ï–†:
"–î–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π —Å–∏–Ω—Ç–µ–∑ –º–µ—Ç–æ–¥–∏–∫ –º–∏—Ä–æ–≤—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –≤ –æ–±–ª–∞—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–µ–π. –î–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–µ—Ä—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É. –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≤—Ä–∞—á–æ–º."

–í–ê–ñ–ù–û:
‚Ä¢ –í—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã —É—á–∏—Ç—ã–≤–∞—Ç—å –ü–û–õ–û–í–´–ï –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ (–º—É–∂—Å–∫–∏–µ/–∂–µ–Ω—Å–∫–∏–µ —Ü–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã)
‚Ä¢ –£—á–∏—Ç—ã–≤–∞—Ç—å –í–û–ó–†–ê–°–¢–ù–´–ï –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ (–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤–æ —Å–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è —Å –≤–æ–∑—Ä–∞—Å—Ç–æ–º)
‚Ä¢ –î–∞–≤–∞—Ç—å –ö–û–ù–ö–†–ï–¢–ù–´–ï –≤—Ä–µ–º—è –∏ –¥–µ–π—Å—Ç–≤–∏—è
‚Ä¢ –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å –†–ï–ê–õ–ò–°–¢–ò–ß–ù–´–ï –ø—Ä–∞–∫—Ç–∏–∫–∏ (5-15 –º–∏–Ω—É—Ç, –Ω–µ —Ç—Ä–µ–±—É—é—â–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è)
‚Ä¢ –£—á–∏—Ç—ã–≤–∞—Ç—å –†–ï–ê–õ–¨–ù–´–ï —É—Å–ª–æ–≤–∏—è –∂–∏–∑–Ω–∏ (—Ä–∞–±–æ—Ç–∞, —Å–µ–º—å—è, –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è)
‚Ä¢ –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ (–ª–µ–¥—è–Ω—ã–µ –≤–∞–Ω–Ω—ã, –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≥–æ–ª–æ–¥–∞–Ω–∏–µ –±–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—è)
‚Ä¢ –¢–û–õ–¨–ö–û –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏
–í–ê–ñ–ù–û:
‚Ä¢ –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –ø–æ –∏–º–µ–Ω–∏
‚Ä¢ –î–∞–π —Å—Ä–∞–∑—É –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏`
        };

        const response = await axios.post(
            'https://api.fireworks.ai/inference/v1/chat/completions',
            {
                model: 'accounts/fireworks/models/deepseek-v3-0324',
                messages: [
                    {
                        role: 'system',
                        content: systemPrompts[specialist] || '–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç.'
                    },
                    {
                        role: 'user',
                        content: prompt
                    }
                ],
                max_tokens: 1500,
                temperature: 0.7
            },
            {
                headers: {
                    'Authorization': 'Bearer fw_8xD76SxbTANnjU33ENAxbK',
                    'Content-Type': 'application/json'
                }
            }
        );

        return response.data.choices[0].message.content;
    } catch (error) {
        console.error('AI –æ—à–∏–±–∫–∞:', error);
        return `–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Ç ${specialist} –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –ø–æ–∑–∂–µ.`;
    }
}

// 1. –¢—Ä–µ–Ω–µ—Ä
app.post('/api/trainer', checkCache, async (req, res) => {
    const userData = req.body.userData;

    const prompt = `
–°–æ–∑–¥–∞–π –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è:
- –ü–æ–ª: ${userData.gender}
- –í–æ–∑—Ä–∞—Å—Ç: ${userData.age} –ª–µ—Ç  
- –í–µ—Å: ${userData.weight}–∫–≥
- –†–æ—Å—Ç: ${userData.height}—Å–º
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${userData.activity}
- –¶–µ–ª—å: ${userData.goal}
- –û–ø—ã—Ç: ${userData.additionalInfo || '–Ω–∞—á–∏–Ω–∞—é—â–∏–π'}

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
üéØ –û–°–ù–û–í–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò: [2-3 –ø—Ä–∏–Ω—Ü–∏–ø–∞]
üèãÔ∏è –ü–†–û–ì–†–ê–ú–ú–ê –¢–†–ï–ù–ò–†–û–í–û–ö: [—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è]
‚ö†Ô∏è –ú–ï–†–´ –ü–†–ï–î–û–°–¢–û–†–û–ñ–ù–û–°–¢–ò: [—á—Ç–æ —É—á–∏—Ç—ã–≤–∞—Ç—å]
üí° –°–û–í–ï–¢–´ –ù–ê –ü–ï–†–í–´–ï –ù–ï–î–ï–õ–ò: [3 —Å–æ–≤–µ—Ç–∞]`;

    const advice = await getAIResponse(prompt, 'trainer');
    res.json({ success: true, advice: advice, type: 'trainer' });
});

// 2. –î–∏–µ—Ç–æ–ª–æ–≥ (–¢–ê–ö–û–ô –ñ–ï –ø—Ä–æ–º–ø—Ç)
app.post('/api/diet', checkCache, async (req, res) => {
    const userData = req.body.userData;

    const prompt = `–î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è:
    –ò–º—è: ${userData.name}
    –ü–æ–ª: ${userData.gender}
    –í–æ–∑—Ä–∞—Å—Ç: ${userData.age} –ª–µ—Ç
    –í–µ—Å: ${userData.weight}–∫–≥
    –†–æ—Å—Ç: ${userData.height}—Å–º
    –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${userData.activity}
    –¶–µ–ª—å: ${userData.goal}
    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: ${userData.additionalInfo || '–Ω–µ—Ç'}`;

    const advice = await getAIResponse(prompt, 'diet');
    res.json({ success: true, advice: advice, type: 'diet' });
});

// 3. –≠–Ω–µ—Ä–≥–∏—è (–¢–ê–ö–û–ô –ñ–ï –ø—Ä–æ–º–ø—Ç)
app.post('/api/energy', checkCache, async (req, res) => {
    const userData = req.body.userData;

    const prompt = `–î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è:
    –ò–º—è: ${userData.name}
    –ü–æ–ª: ${userData.gender}
    –í–æ–∑—Ä–∞—Å—Ç: ${userData.age} –ª–µ—Ç
    –í–µ—Å: ${userData.weight}–∫–≥
    –†–æ—Å—Ç: ${userData.height}—Å–º
    –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${userData.activity}
    –¶–µ–ª—å: ${userData.goal}
    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: ${userData.additionalInfo || '–Ω–µ—Ç'}`;

    const advice = await getAIResponse(prompt, 'energy');
    res.json({ success: true, advice: advice, type: 'energy' });
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
app.listen(PORT, () => {
    console.log(`üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:${PORT}`);
    console.log(`ü§ñ AI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: Fireworks –∞–∫—Ç–∏–≤–Ω–∞`);
});

module.exports = app;